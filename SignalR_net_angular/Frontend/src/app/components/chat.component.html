<div class="chat-container">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <div class="user-info">
        <h3>{{ currentUser?.displayName || currentUser?.username }}</h3>
        <span class="user-status">ƒêang ho·∫°t ƒë·ªông</span>
      </div>
      <button class="btn-icon" (click)="logout()" title="ƒêƒÉng xu·∫•t">
        üö™
      </button>
    </div>

    <div class="search-bar">
      <input
        type="text"
        placeholder="T√¨m ki·∫øm ng∆∞·ªùi d√πng..."
        [(ngModel)]="searchQuery"
        (input)="onSearchChange()"
        (focus)="showUserList = true">
    </div>

    <!-- User List (khi search) -->
    <div *ngIf="showUserList && searchQuery" class="user-list">
      <div
        *ngFor="let user of users"
        class="user-item"
        (click)="startChatWithUser(user)">
        <div class="user-avatar">{{ getDisplayName(user).charAt(0).toUpperCase() }}</div>
        <div class="user-details">
          <div class="user-name">{{ getDisplayName(user) }}</div>
          <div class="user-status-text">
            <span [class.online]="user.isOnline" [class.offline]="!user.isOnline">
              {{ user.isOnline ? 'ƒêang ho·∫°t ƒë·ªông' : 'Offline' }}
            </span>
          </div>
        </div>
      </div>
      <div *ngIf="users.length === 0" class="empty-state">
        Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng
      </div>
    </div>

    <!-- Conversations List -->
    <div *ngIf="!showUserList || !searchQuery" class="conversations-list">
      <div
        *ngFor="let conv of conversations"
        class="conversation-item"
        [class.active]="selectedConversation?.id === conv.id"
        (click)="selectConversation(conv)">
        <div class="conversation-avatar">
          {{ getDisplayName(conv).charAt(0).toUpperCase() }}
          <span *ngIf="conv.otherIsOnline" class="online-indicator"></span>
        </div>
        <div class="conversation-details">
          <div class="conversation-header">
            <span class="conversation-name">{{ getDisplayName(conv) }}</span>
            <span class="conversation-time">{{ formatTime(conv.lastMessageAt) }}</span>
          </div>
          <div class="conversation-preview">
            <span *ngIf="conv.lastMessage">{{ conv.lastMessage.content }}</span>
            <span *ngIf="!conv.lastMessage">Ch∆∞a c√≥ tin nh·∫Øn</span>
            <span *ngIf="conv.unreadCount > 0" class="unread-badge">{{ conv.unreadCount }}</span>
          </div>
        </div>
      </div>
      <div *ngIf="conversations.length === 0" class="empty-state">
        Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán n√†o
      </div>
    </div>
  </div>

  <!-- Chat Area -->
  <div class="chat-area">
    <div *ngIf="!selectedConversation" class="no-conversation">
      <h2>üí¨ Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán ƒë·ªÉ b·∫Øt ƒë·∫ßu</h2>
      <p>Ho·∫∑c t√¨m ki·∫øm ng∆∞·ªùi d√πng ƒë·ªÉ b·∫Øt ƒë·∫ßu chat m·ªõi</p>
    </div>

    <div *ngIf="selectedConversation" class="chat-window">
      <!-- Chat Header -->
      <div class="chat-header">
        <div class="chat-user-info">
          <div class="chat-avatar">
            {{ getDisplayName(selectedConversation).charAt(0).toUpperCase() }}
            <span *ngIf="selectedConversation.otherIsOnline" class="online-indicator"></span>
          </div>
          <div>
            <div class="chat-user-name">{{ getDisplayName(selectedConversation) }}</div>
            <div class="chat-user-status">
              {{ selectedConversation.otherIsOnline ? 'ƒêang ho·∫°t ƒë·ªông' : 'Offline' }}
            </div>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div class="messages-container">
        <div *ngIf="isLoading" class="loading">ƒêang t·∫£i tin nh·∫Øn...</div>
        <div
          *ngFor="let message of messages"
          class="message"
          [class.sent]="message.senderId === currentUser?.userId"
          [class.received]="message.senderId !== currentUser?.userId">
          <div class="message-content">
            <div class="message-text">{{ message.content }}</div>
            <div class="message-time">{{ formatTime(message.sentAt) }}</div>
          </div>
        </div>
      </div>

      <!-- Message Input -->
      <div class="message-input-container">
        <input
          type="text"
          class="message-input"
          placeholder="Nh·∫≠p tin nh·∫Øn..."
          [(ngModel)]="newMessage"
          (keydown.enter)="sendMessage()">
        <button class="send-button" (click)="sendMessage()" [disabled]="!newMessage.trim()">
          G·ª≠i
        </button>
      </div>
    </div>
  </div>

  <!-- Mongo Chat Area (View ri√™ng) -->
  <div class="chat-area mongo-panel">
    <div class="chat-window">
      <div class="chat-header">
        <div>
          <h3>Chat MongoDB</h3>
          <div class="chat-user-status">Tin nh·∫Øn l∆∞u tr·ª±c ti·∫øp Mongo (kh√¥ng qua SignalR)</div>
        </div>
      </div>

      <div class="mongo-body">
        <div class="mongo-users">
          <h4>Ch·ªçn ng∆∞·ªùi ƒë·ªÉ chat (Mongo)</h4>
          <div class="mongo-user-list">
            <div
              *ngFor="let user of users"
              class="mongo-user-item"
              [class.active]="mongoSelectedUser?.id === user.id"
              (click)="selectMongoUser(user)">
              <div class="user-avatar">{{ getDisplayName(user).charAt(0).toUpperCase() }}</div>
              <div class="user-details">
                <div class="user-name">{{ getDisplayName(user) }}</div>
                <div class="user-status-text">
                  <span [class.online]="user.isOnline" [class.offline]="!user.isOnline">
                    {{ user.isOnline ? 'ƒêang ho·∫°t ƒë·ªông' : 'Offline' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="mongo-chat-box">
          <div class="messages-container">
            <div *ngIf="mongoLoading" class="loading">ƒêang t·∫£i tin nh·∫Øn (Mongo)...</div>
            <div
              *ngFor="let message of mongoMessages"
              class="message"
              [class.sent]="message.senderId === currentUser?.userId"
              [class.received]="message.senderId !== currentUser?.userId">
              <div class="message-content">
                <div class="message-text">{{ message.content }}</div>
                <div class="message-time">{{ formatTime(message.sentAt) }}</div>
              </div>
            </div>
          </div>

          <div class="message-input-container">
            <input
              type="text"
              class="message-input"
              placeholder="Nh·∫≠p tin nh·∫Øn (Mongo)..."
              [(ngModel)]="mongoNewMessage"
              (keydown.enter)="sendMongoMessage()">
            <button class="send-button" (click)="sendMongoMessage()" [disabled]="!mongoNewMessage.trim() || !mongoSelectedUser">
              G·ª≠i Mongo
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

